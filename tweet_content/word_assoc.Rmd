---
title: "word_assoc"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library(tidyverse)
library(tidytext)
library(stringr)
library(ggraph)
library(igraph)
library(wordcloud)
library(kableExtra)
library(knitr)

twitter_merged_noRT <- read.csv("twitter_merged_noRT.csv", stringsAsFactors = FALSE) %>%
  distinct()

noRT <- twitter_merged_noRT %>%
  arrange(-retweet_count) %>%
  filter(screen_name != "Pontifex") #remove the pope..

```

```{r, include=FALSE}
##functions

source("text_analysis_functions.R")
```
  
    
```{r, include=FALSE}
#creating dataset for each seach term - this will be used for analysis and to create a figure comparing the sizes of the dataframes produced by each query

#### soil
soil_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "soil"))


#### rangeland 
rangeland_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "rangeland"))

#### forest 
forest_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "forest"))



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#### soil health
soil_health_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "soil health"))


#### rangeland 
rangeland_health_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "rangeland health"))

#### forest 
forest_health_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "forest health"))


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#### soil quality
soil_quality_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "soil quality"))


#### rangeland quality
rangeland_quality_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "rangeland quality"))

#### forest quality
forest_quality_tweets <- twitter_merged_noRT %>% 
  filter(
    str_detect(tolower(text), "forest quality"))


``` 

### Length of dataframes produced by each query term
it is import to keep in mind for all results (including here, in wordclouds, and bigram plots) that the number of hits for each query term varies dramatically, with "soil" terms being used far more frequently than "rangeland" or "forest" terms. For this reason, it may not be very valuable to perform this sort of analysis while looking at the most influential tweets. Nevertheless, this it seems valuable to get a feel for the different language being used within each category
```{r, echo = F}
#create data fram showing the size of each data frame produced by each query
total_counts <- data.frame(c("soil", "rangeland","forest","soil health","rangeland health","forest health","soil quality", "rangeland quality","forest quality"), c(nrow(soil_tweets),nrow(rangeland_tweets),nrow(forest_tweets), nrow(soil_health_tweets),nrow(rangeland_health_tweets),nrow(forest_health_tweets),nrow(soil_quality_tweets),nrow(rangeland_quality_tweets),nrow(forest_quality_tweets)))

names(total_counts) <- c("query", "counts")

ggplot(total_counts, aes(x = query)) +
  geom_col(aes(y = counts)) + 
  theme_bw() +
  coord_flip()

```

#same as above without 'soil'
```{r}
count_noSoil <- filter(total_counts, query != "soil")

ggplot(count_noSoil, aes(x = query)) +
  geom_col(aes(y = counts)) + 
  theme_bw() +
  coord_flip()
```

```{r, echo=F}
#table of results for a different perspective
kable(total_counts) 

```


### visualizing propotions  
three categories using word lists created by filtering: "soil" "rangeland" "forest"  
  


  These were created by creating a word list based on the top 10 words for each category, then using that word list as a filter for all categories (therefore only words that appeared in all three groupings are compared in this figure) so that we can compare the relative proportion of each word found in each category
```{r, echo=F, fig.width=12}

###Forest
#create word count
forest_word_count <- prepare_text(forest_tweets) %>% 
  filter(word != "forest")
#calculate relative proportions of words
forest_prop <- forest_word_count %>% 
  mutate(forest_prop = round(n/sum(n), 4)) %>% 
  select(-n)


###soil
soil_word_count <- prepare_text(soil_tweets)

soil_prop <- soil_word_count %>% 
  mutate(soil_prop = round(n/sum(n), 4)) %>% 
  select(-n)


###forest
rangeland_word_count <- prepare_text(rangeland_tweets) %>% 
  filter(word != "rangeland")

range_prop <- rangeland_word_count %>% 
  mutate(range_prop = round(n/sum(n), 4)) %>% 
  select(-n)

total_prop <- merge(merge(forest_prop, soil_prop), range_prop)

#create word list:
top_soil <- head(soil_prop, 10)
top_range <- head(range_prop, 10) 
top_forest <- head(forest_prop, 10)

word_list <- c(paste(top_soil$word), paste(top_forest$word), paste(top_range$word))

#filter and restructure for visualization
selected_prop <- total_prop %>% 
  filter(word %in% word_list) %>% 
  gather("querry", "proportion", -word)

#plot
ggplot(selected_prop, aes(word, proportion)) +
  geom_col(aes(fill = word)) +
  facet_wrap(~querry) +
  coord_flip() +
  labs(title = "'rangeland' v 'soil' v 'forest'") +
  theme_bw()

```


Repeated to include 'soil' and 'health' terms
```{r, echo=F, fig.width=12}

###Forest
#create word count
forest_word_count <- prepare_text_full(forest_tweets) %>% 
  filter(word != "forest")
#calculate relative proportions of words
forest_prop <- forest_word_count %>% 
  mutate(forest_prop = round(n/sum(n), 4)) %>% 
  select(-n)


###soil
soil_word_count <- prepare_text_full(soil_tweets)

soil_prop <- soil_word_count %>% 
  mutate(soil_prop = round(n/sum(n), 4)) %>% 
  select(-n)


###forest
rangeland_word_count <- prepare_text_full(rangeland_tweets) %>% 
  filter(word != "rangeland")

range_prop <- rangeland_word_count %>% 
  mutate(range_prop = round(n/sum(n), 4)) %>% 
  select(-n)

total_prop <- merge(merge(forest_prop, soil_prop), range_prop)

#create word list:
top_soil <- head(soil_prop, 10)
top_range <- head(range_prop, 10) 
top_forest <- head(forest_prop, 10)

word_list <- c(paste(top_soil$word), paste(top_forest$word), paste(top_range$word))

#filter and restructure for visualization
selected_prop <- total_prop %>% 
  filter(word %in% word_list) %>% 
  gather("querry", "proportion", -word)

#plot
ggplot(selected_prop, aes(word, proportion)) +
  geom_col(aes(fill = word)) +
  facet_wrap(~querry) +
  coord_flip() +
  labs(title = "'rangeland' v 'soil' v 'forest'") +
  theme_bw()

```


*** 
    
  Top words (by proportion) for each category:  
  

```{r,echo=F, fig.width=12}
kable(list(top_forest,top_range,top_soil))%>%
kable_styling(latex_options = c("striped", "scale_down"))

```

***  

## comparing "soil health", "rangeland health", "forest health"
note: only common 'top' word was biodiversity
```{r, echo=F,fig.width=12}

### soil health
soil_health_wc <- prepare_text(soil_health_tweets)


#### rangeland health 

#creat word count
rangeland_health_wc <- prepare_text(rangeland_health_tweets) %>% 
  filter(word != "rangeland")



#### forest health 

#creat word count
forest_health_wc <- prepare_text(forest_health_tweets) %>% 
  filter(word != "forest")


##### visualizing propotions 

#this is a very rough thought as a method for comparing proportion
forest_health_prop <- forest_health_wc %>% 
  mutate(forest_prop = round(n/sum(n), 4)) %>% 
  select(-n)

soil_health_prop <- soil_health_wc %>% 
  mutate(soil_prop = round(n/sum(n), 4)) %>% 
  select(-n)

range_health_prop <- rangeland_health_wc %>% 
  mutate(range_prop = round(n/sum(n), 4)) %>% 
  select(-n)

total_health_prop <- merge(merge(forest_health_prop, soil_health_prop), range_health_prop)



#create word list:
top_soil_health <- head(soil_health_prop, 10)
top_range_health <- head(range_health_prop, 10) 
top_forest_health <- head(forest_health_prop, 10)

word_list <- c(paste(top_soil_health$word), paste(top_forest_health$word), paste(top_range_health$word))

#filter and restructure for visualization
selected_health_prop <- total_health_prop %>% 
  filter(word %in% word_list) %>% 
  gather("querry", "proportion", -word)

ggplot(selected_health_prop, aes(word, proportion)) +
  geom_col(aes(fill = word)) +
  facet_wrap(~querry) +
  coord_flip() +
  theme_bw()
```

Top words (by proportion) for each "health" category:  
```{r, echo=F}
kable(list(top_forest_health,top_range_health,top_soil_health))%>%
kable_styling(latex_options = c("striped", "scale_down"))
```
***
***  

### comparing "soil quality", "rangeland quality", "forest quality"
This analysis is not valuable as "rangeland quality" had only 1 hit and "forest quality" had no hits




