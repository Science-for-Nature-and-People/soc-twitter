---
title: "decay"
author: "Meilin"
date: "8/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load packages
library(tidyverse)
library(tidytext)
library(stringr)
library(ggraph)
library(igraph)
library(tm)
library(NLP)
library(quanteda)
library(lubridate)
library(dplyr)
library(ggplot2)
source("../text_analysis_functions.R")

# load data
noRT <- read.csv("/home/shares/soilcarbon/Twitter/Merged_v2/twitter_merged_noRT_v2.csv", stringsAsFactors = FALSE)
RT <- read.csv("/home/shares/soilcarbon/Twitter/Merged_v2/twitter_merged_v2.csv",stringsAsFactors = FALSE)
```

### noRT dataset
```{r}
#clean data to remove numbers, usernames, websites, non-ASCII characters and outlier
#noRT_clean <- removeNumbers(noRT$text)
noRT_clean <- noRT$text
noRT_clean <- gsub("@\\w+","",noRT_clean)
noRT_clean <- gsub(" ?(f|ht)tp(s?)://(.*)[.][a-z]+", "", noRT_clean)
noRT_clean <- gsub("#\\s+","", noRT_clean)
noRT_clean <- gsub("&amp", "", noRT_clean)
noRT_clean <- gsub("[^\x01-\x7F]", "", noRT_clean)

noRT$text <- noRT_clean
noRT <- noRT %>% 
  filter(source != "Twittascope") 

# to remove the pope
noRT <- noRT %>%
  arrange(-retweet_count) %>%
  filter(screen_name != "Pontifex")

# to remove all india related tweets
noRT_india <- flag_india(noRT)
noRT_no_india <- noRT_india %>% 
  filter(is_india == 0)
```

### RT dataset
```{r}
#clean data to remove numbers, usernames, websites, non-ASCII characters and outlier
#RT_clean <- removeNumbers(RT$text)
RT_clean <- RT$text
RT_clean <- gsub("@\\w+","",RT_clean)
RT_clean <- gsub(" ?(f|ht)tp(s?)://(.*)[.][a-z]+", "", RT_clean)
RT_clean <- gsub("#\\s+","", RT_clean)
RT_clean <- gsub("&amp", "", RT_clean)
RT_clean <- gsub("[^\x01-\x7F]", "", RT_clean)

RT$text <- RT_clean
RT <- RT %>% 
  filter(source != "Twittascope") 

# to remove the pope
RT <- RT %>%
  arrange(-retweet_count) %>%
  filter(screen_name != "Pontifex")

# to remove all india related tweets
RT_india <- flag_india(RT)
RT_no_india <- RT_india %>% 
  filter(is_india == 0)
```

### select the SHS 2019 conference
```{r}
# filter out tweets with hashtag
# #SoilSummit19

input <- noRT_no_india

SHS19 <- input %>% 
  filter(str_detect(tolower(text), "soilsummit19"))
SHS19$conference <- "SHS19"

# the five most retweeted tweets
SHS19_top5 <- SHS19 %>% arrange(-retweet_count) %>% head(5)
# select the RT of SHS19
SHS19_RT <- RT %>% filter(str_detect(tolower(text), "soilsummit19")) 
# select the RT of the top five
SHS19_RT_top5 <- SHS19_RT %>% filter(retweet_count >= 8) %>% filter(is_retweet == T)

```

```{r}
# barplot to show time series on retweet counts

ggplot(SHS19, aes(y = retweet_count, x = date(created_at), fill = conference)) + 
  geom_bar(stat = "identity") + ggtitle('Soil Health Summit 2019 Tweets')
```

```{r}
# barplot to show time series on total tweets counts
SHS19$date <- date(SHS19$created_at)

Event_19 <- data.frame(SHS19$date, SHS19$conference)
names(Event_19) <- c("date","Conference")

#count value based on week and query words
library(plyr)
counts.df <- ddply(Event_19, .(Event_19$date, Event_19$Conference), nrow)
names(counts.df) <- c("Date", "Conference", "Freq")

ggplot(counts.df, aes(y = Freq, x = Date, fill = Conference)) + 
  geom_bar(stat = "identity") + ggtitle('Number of Tweets on SHS 2019')
```

### barplot to show the decay of five most retweeted tweets from 2019 conference
```{r}
library(plyr)
counts.df <- ddply(SHS19_RT_top5, .(date(SHS19_RT_top5$created_at)), nrow)
names(counts.df) <- c("Date", "Number")

ggplot(counts.df, aes(y = Number, x = Date)) +
  geom_bar(stat = "identity") + ggtitle('Decay of SHS 2019 top 5 retweets') 


```

### select the 10 most retweeted tweets overall
### across all search terms
```{r}
# select 10 highly retweeted tweets and plot the decay
test <- RT_no_india %>% 
  filter(retweet_count < 3050 & retweet_count > 280)


#count based on retweet date
library(plyr)
counts.df <- ddply(test, .(date(test$created_at), test$hits), nrow)
names(counts.df) <- c("Date", "Hits", "Number")
counts.df <- counts.df %>% filter (Hits != "NA")
counts.df$Hits[counts.df$Hits == "healthy soil"] <- "soil health"

ggplot(counts.df, aes(y = Number, x = Date, fill = Hits)) +
  geom_bar(stat = "identity") + ggtitle('Decay of 10 most retweeted tweets')


```

```{r}
# write a function to find retweet and plot decay for certain tweet based on retweet count rank
library(plyr)

find_rt <- function(rank) {
  result_rt <- RT_no_india %>% 
    filter(substring(RT_no_india$text, 1, 30) == substring(noRT_no_india$text[rank], 1, 30))
  result.df <- ddply(result_rt, .(date(result_rt$created_at), result_rt$query), nrow)
  names(result.df) <- c("Date", "Query", "Number")
  result.df$day_since <- result.df$Date - date(noRT_no_india$created_at[rank])
  result.df$content <- substring(result_rt$text[1], 1, 30)
  names(result.df) <- c("Date", "Query", "Number", "Day_since", "Content")
  return(result.df)
}
```

```{r}
# combine the top five retweets and plot
first <- find_rt(1)
second <- find_rt(2)
third <- find_rt(3)
fourth <- find_rt(4)
fifth <- find_rt(5)

top5 <- rbind(first, second, third, fourth, fifth)
# filtering the data frame by number > 2 to avoid long tail
top5 <- top5 %>% 
  filter(top5$Number > 2)
ggplot(top5, aes(x = Day_since, y = Number, color = Content)) +  geom_line()
```


### Network Diagram
```{r}
# select a sample tweet with TOP 5 retweet
tt <- data.frame(SHS19_RT_top5$text,SHS19_RT_top5$screen_name)
names(tt) <- c("text", "retweet_user")
tt$author <- SHS19_top5$screen_name[match(tt$text, SHS19_top5$text)]

network <- tt %>% filter(tt$author != "NA")
```

```{r}
# tweet/RT user network visualization

# generate node list
authors <- network %>% distinct(author) 
names(authors) <- "label"
retweet_users <- network %>% distinct(retweet_user) 
names(retweet_users) <- "label"

nodes <- rbind(authors, retweet_users)
nodes <- nodes %>% rowid_to_column("id")
```

```{r}
# generate edge list
library(plyr)
per_route <- ddply(network, .(network$author, network$retweet_user), nrow)
names(per_route) <- c("authors", "retweet_users", "weight")

edges <- per_route %>% left_join(nodes, by = c("authors" = "label"))
colnames(edges)[4] <- "from"
edges <- edges %>% 
  left_join(nodes, by = c("retweet_users" = "label"))
colnames(edges)[5] <- "to"

edges <- select(edges, from, to, weight)
edges
```

```{r}
library(network)
routes_network <- network(edges, vertex.attr = nodes, matrix.type = "edgelist", ignore.eval = FALSE)
plot(routes_network, vertex.cex = 2)
```
```{r}
# ggraph packages to show network diagram
library(tidygraph)
library(ggraph)

routes_tidy <- tbl_graph(nodes = nodes, edges = edges, directed = TRUE)
routes_igraph_tidy <- as_tbl_graph(routes_igraph)

routes_tidy %>% 
  activate(edges) %>% 
  arrange(desc(weight))

ggraph(routes_tidy, layout = "graphopt") + 
  geom_node_point() +
  geom_edge_link(aes(width = weight), alpha = 0.8) + 
  scale_edge_width(range = c(0.1, 0.5)) +
  geom_node_text(aes(label = label), label.size = 0.25, repel = TRUE) +
  labs(edge_width = "Number") +
  theme_graph()

ggraph(routes_igraph, layout = "linear") + 
  geom_edge_arc(aes(width = weight), alpha = 0.8) + 
  scale_edge_width(range = c(0.1, 0.5)) +
 # geom_node_text(aes(label = label)) +
  labs(edge_width = "Number") +
  theme_graph()
```



